<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
        http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.9.xsd">

    <changeSet id="2025-12-26 users and logons" author="Sabadin Ivan" context="dev">
        <createTable tableName="sec_users" remarks="Пользователи системы">
            <column name="id" remarks="Идентификатор сущности" type="java.sql.Types.BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_user"/>
            </column>
            <column name="version" remarks="Версия сущности" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="first_name" remarks="Имя пользователя" type="java.sql.Types.VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="last_name" remarks="Фамилия пользователя" type="java.sql.Types.VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="middle_name" remarks="Отчество пользователя" type="java.sql.Types.VARCHAR">
                <constraints nullable="true"/>
            </column>
            <column name="email" remarks="Почтовый ящик пользователя" type="java.sql.Types.VARCHAR">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <sql dbms="postgresql">select setval('sec_users_id_seq', ${id.start.value});</sql>

        <createTable tableName="sec_user_logons" remarks="Учетные записи пользователей">
            <column name="id" remarks="Идентификатор сущности" type="java.sql.Types.BIGINT" autoIncrement="true">
                <constraints primaryKey="true" primaryKeyName="pk_user_logon"/>
            </column>
            <column name="version" remarks="Версия сущности" type="java.sql.Types.INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="user_id" remarks="Идентификатор пользователя" type="java.sql.Types.BIGINT">
                <constraints nullable="false" foreignKeyName="fk_userlogon_user"
                             referencedTableName="sec_users" referencedColumnNames="id"/>
            </column>
            <column name="logon_name" remarks="Имя для входа в систему" type="java.sql.Types.VARCHAR">
                <constraints nullable="false"/>
            </column>
            <column name="password_hash" remarks="Хэш пароля" type="java.sql.Types.VARCHAR(256)"/>
            <column name="is_active" remarks="Актуальность" type="java.sql.Types.BOOLEAN" defaultValueBoolean="true">
                <constraints nullable="false"/>
            </column>
        </createTable>
        <addUniqueConstraint constraintName="UQ_USER_LOGONS"
                             tableName="SEC_USER_LOGONS" columnNames="logon_name"/>
        <sql dbms="postgresql">select setval('sec_user_logons_id_seq', ${id.start.value});</sql>
    </changeSet>

</databaseChangeLog>